# 权限管理

## 功能介绍

- 菜单管理

  - 设置用户可以访问的所有路由菜单和相应的按钮权限

- 角色管理

  - 设置角色的访问权限（路由权限和按钮权限）

- 用户管理
  - 给创建的用户绑定上某个角色（就会拥有这个角色的权限）

使用某个用户登录，只能访问这个用户对应角色拥有的权限路由和权限按钮

## 原理实现

1. 路由权限

- 在全局路由前置守卫完成的
- 首先从 vuex 中取出 token，判断是否有 token
  - 有（代表用户之前登录过）
    - 优化：取出用户数据判断是否存在
      - 存在说明之前登录成功过且数据没问题，直接放行
      - 不存在，说明之前没有登录成功过，需要进行下面步骤
    - 需要验证 token 是否有效（是否是真实 token 且没有过期）
    - 通过发送请求请求用户数据，此时在拦截器中请求头会携带上了 token，后台会自动进行验证 token 的有效性（try catch）
    - 有效
      - 得到了用户数据（其中包含了按钮权限数据和菜单权限数据）
      - 菜单权限数据需要处理组件，组件需要使用真正的组件，使用递归遍历处理所有菜单
      - 通过 router.addRoutes()，来动态添加路由，从而路由生效
        - 一上来路由中只有登录、404、首页等路由配置，其他都没有，所以一上来用户只能访问这些页面
        - 一旦动态添加路由，用户访问的路由就更多了，从而实现路由的权限控制
      - 跳转到 to.path
    - 失效
      - 清空 token，跳转到登录页面

  - 没有（代表用户之前没有登录过）
    - 判断要去路由路径（to.path）是否是 login
      - 是 调用 next()放行
      - 不是 调用 next({ path: '/login' })强行跳转到 login
        - 有一个对用户体验更好的小功能 - 重定向
          - 跳转到 login 时加上一个 query 参数 redirect，值为 to.path
          - 当将来登录成功时，会拿到 redirect 进行跳转，而不是首页

2. 按钮权限

- 在全局路由前置守卫获取用户数据的时候，同时也获取到了按钮权限列表，存在了 vuex 中
- 按钮权限列表就是一个数组。数组有 n 个按钮的权限值（字符串、id）
- 每一个路由组件的功能按钮也会有自己的权限值
- 判断路由组件的功能按钮的权限值在不在请求回来按钮权限列表中
  - 在说明有权限。通过 v-if 来显示
  - 不在说明没有权限。通过 v-if 来隐藏
- 从而实现按钮权限控制
- 优化：因为很多按钮都有相同的判断，设计一个公共判断的方法 hasBtnPermission，挂载到 Vue 的原型上，从而所有组件实例都可以复用
